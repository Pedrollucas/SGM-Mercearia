<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SGM - Mercearia</title>
    <style>
      :root{--accent:#2b8a7a;--muted:#f2f2f2;--bg:#f4f7f6;--panel:#ffffff;--primary:#176B87}
      body{font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;margin:0;background:var(--bg);color:#0f1720}
      header{background:linear-gradient(90deg,var(--primary),#2b8a7a);padding:12px 18px;color:#fff;display:flex;align-items:center;justify-content:space-between;box-shadow:0 6px 18px rgba(15,23,32,0.06)}
      header .left,header .center,header .right{display:flex;align-items:center}
      header .center{flex:1;justify-content:center;font-weight:600}
      .app-wrap{display:grid;grid-template-columns:280px 1fr 240px;gap:18px;min-height:calc(100vh - 36px);padding:18px;max-width:1200px;margin:18px auto}
      aside{background:var(--panel);padding:14px;border-radius:10px;color:#0f1720;box-shadow:0 6px 18px rgba(15,23,32,0.04)}
      main{background:var(--panel);padding:20px;border-radius:10px;min-height:520px;box-shadow:0 6px 18px rgba(15,23,32,0.04)}
      .no-content{display:flex;align-items:center;justify-content:center;height:100%;color:#475569}
      .flash{background:#e7f5e6;padding:10px;margin-bottom:10px;color:#064;border-radius:6px}
      .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
      .btn.ghost{background:transparent;color:var(--primary);box-shadow:none;border:1px solid rgba(23,107,135,0.08)}
      .btn.small{padding:6px 8px;font-size:0.9rem;border-radius:6px}
      .icon-gear{margin-left:8px;cursor:pointer;font-size:1.1rem}
      .search-input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef0;background:#fbfcfc}
      .client-list{margin-top:12px;padding:6px;max-height:64vh;overflow:auto}
      .client-item{padding:10px;border-radius:8px;background:linear-gradient(180deg,rgba(0,0,0,0.02),transparent);margin-bottom:8px;cursor:pointer;transition:all .12s}
      .client-item:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(15,23,32,0.06)}
      .client-item.active{background:linear-gradient(90deg,var(--accent),#6cc8b0);color:#fff}
      .client-name{font-weight:600}
      .muted{color:#64748b}
      @media(max-width:900px){.app-wrap{grid-template-columns:1fr;grid-template-rows:auto auto;max-width:92%;padding:12px}}
    </style>
    <script>
      function goHome(){ window.location.href = {{ url_for('main.home')|tojson }}; }
      function logout(){ window.location.href = {{ url_for('main.logout')|tojson }}; }
    </script>
  </head>
  <body>
    {% if session.get('user_id') %}
    <header>
      <div class="left">
        <button class="btn" onclick="goHome()">◀ Início</button>
      </div>
      <div class="center"><strong>{{ session.get('user_nome') }}</strong></div>
      <div class="right">
        {% if session.get('user_tipo') == 'Administrador' %}
        <a href="{{ url_for('main.admin_usuarios') }}" class="icon-gear">⚙</a>
        {% endif %}
        <button class="btn" onclick="logout()">Sair</button>
      </div>
    </header>

      <div class="app-wrap">
      <aside>
        <input
          id="client-search"
          class="search-input"
          placeholder="nome do cliente"
        />
        <button
          id="btn-new-client"
            class="btn"
            style="float: right; margin-top: -40px"
        >
          +
        </button>
          <div id="client-list" class="client-list"></div>
      </aside>

      <main id="main-content">
        {% with messages = get_flashed_messages() %} {% if messages %} {% for m
        in messages %}
        <div class="flash">{{ m }}</div>
        {% endfor %} {% endif %} {% endwith %} {% block content %}{% endblock %}
      </main>

      <aside style="background:var(--panel);color:#0f1720;padding:10px;border-radius:6px">
        <!-- espaço lateral direito para extras -->
        <h4>Atalhos</h4>
        <ul>
          <li>
            <a href="{{ url_for('main.listar_dividas') }}">Ver Dívidas</a>
          </li>
          <li>
            <a href="{{ url_for('main.relatorio_dashboard') }}">Dashboard</a>
          </li>
        </ul>
      </aside>
      <!-- footer removed as requested -->
    </div>

    <script>
      async function fetchClients(q = "") {
        const res = await fetch("/api/clientes?q=" + encodeURIComponent(q));
        const data = await res.json();
        const list = document.getElementById("client-list");
        list.innerHTML = "";
        data.forEach((c) => {
          const el = document.createElement("div");
          el.classList.add('client-item');
          el.dataset.id = c.id;
          el.innerHTML = `<div class="client-name">${c.nome}</div><div class="muted">ID: ${c.id}</div>`;
          el.onclick = async () => {
            // remove active from others
            document.querySelectorAll('.client-item').forEach(x=>x.classList.remove('active'));
            el.classList.add('active');
            await loadClient(c.id);
          };
          list.appendChild(el);
        });
      }

      async function loadClient(id) {
        const res = await fetch("/api/cliente/" + id);
        const data = await res.json();
        const main = document.getElementById("main-content");
        // construir perfil do cliente
        let html = `<h2>${data.nome} (ID: ${data.id})</h2>`;
        html += `<p>CPF: ${data.cpf || ""} • Cel: ${data.celular || ""}</p>`;
        html += `<p>Endereço: ${data.endereco || ""}</p>`;
        html += `<div style="margin-top:10px"><button class='btn' onclick="location.href='/dividas/novo?cliente_id=${data.id}'">Lançar Dívida</button> <button class='btn' onclick="location.href='/dividas'">Lançar Pagamento</button></div>`;
        html += `<h3>Histórico de Dívidas</h3>`;
        data.dividas.forEach((d) => {
          html += `<div style='background:#fff;padding:8px;margin:8px 0;color:#000'><strong>ID ${
            d.id
          }</strong> - ${d.descricao}<br>Valor: R$ ${d.valor_original.toFixed(
            2
          )} • Saldo: R$ ${d.saldo.toFixed(2)} • Venc.: ${
            d.vencimento
          } • Status: ${d.status}`;
          if (d.pagamentos.length) {
            html +=
              "<br><em>Pagamentos:</em>" +
              d.pagamentos
                .map(
                  (p) =>
                    `<div>${p.data} R$ ${p.valor.toFixed(2)} (${p.meio})</div>`
                )
                .join("");
          }
          if (d.renegociacoes.length) {
            html +=
              "<br><em>Renegociações:</em>" +
              d.renegociacoes
                .map(
                  (r) =>
                    `<div>${r.data} → ${r.nova_data_venc} (+${r.juros}%)</div>`
                )
                .join("");
          }
          html += `</div>`;
        });
        main.innerHTML = html;
      }

        document.getElementById("client-search").addEventListener("input", (e) => {
          fetchClients(e.target.value);
        });
        document.getElementById("btn-new-client").addEventListener("click", () => {
          location.href = "/clientes/novo";
        });
      // carregar lista inicial
      fetchClients();
    </script>

    {% else %} {% with messages = get_flashed_messages() %} {% if messages %} {%
    for m in messages %}
    <div class="flash">{{ m }}</div>
    {% endfor %} {% endif %} {% endwith %}
    <div style="padding: 40px"></div>
    {% endif %}
  </body>
</html>
